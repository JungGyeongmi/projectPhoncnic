<!DOCTYPE html>
<html lang="ko" xmls:th="http://www.thymeleaf.org">
<style>
  .containerBox {
    max-width: 650px;
    margin: 0 auto;
    font-family: 'GmarketSansLight';
  }
  .my.btn {
    background-color: #e9ecef;
    margin:60px auto 60px auto;
    height: 52px;
    border-radius: 13px;
    font-weight: bold;
    font-size: 22px;
  }

  .my.btn:hover {
    background-color: #DBE9B7;
  }

hr {
  margin-top: 0 !important;
  margin-bottom: 25px !important;
  color: black !important;
}

.p-line{
  margin-bottom: 0;
  font-weight: bold;
  color: black;

}
#roofChoice {
  background-color: #e9ecef;
}

#roofChoice:hover {
  background-color: #dbdde0;
}

span>label {
  padding: 15px; 
}

span>label:hover {
  cursor: pointer;
}

input[type=radio]:checked + label {
  background-color: #DBE9B7;
  border-radius: 5px;
}

.roofmodal{
  max-width: 757px !important;
}

.menuuploadResult {
    width: 100%;
    background: #e9ecef;
    margin-top: 10px 0;
    border-radius: 5px;
}

.menuuploadResult ul {
    display: flex;
    flex-flow: row;
    justify-content: center;
    align-items: center;
    overflow: auto;
}

.menuuploadResult ul li {
    list-style: none;
    padding: 10px;
}

.menuuploadResult ul li img {
    width: 100px;
}
.menuuploadResult button{
    border: none;
    background: none;
}

.backgroundshowResult {
    width: 100%;
    background: #e9ecef;
    margin-top: 10px 0;
    border-radius: 5px;
}

.backgroundshowResult ul {
    display: flex;
    flex-flow: row;
    justify-content: center;
    align-items: center;
    overflow: auto;
}

.backgroundshowResult ul li {
    list-style: none;
    padding: 10px;
}

.backgroundshowResult ul li img {
    width: 100px;
}
.backgroundshowResult button{
    border: none;
    background: none;
}

.modal-body{
  text-align: center !important;
}

@media (min-width: 576px){
.modal-dialog {
    margin: 5.75rem auto !important;
  }
}

</style>
<th:block th:replace="~{layout/basic :: setContent(~{::content})}">
  <th:block th:fragment="content">
    <div class="containerBox">
      <div class="row">
        <h3 class="py-5" style="font-family: 'GmarketSansMedium';">
          <img th:src="@{/icon/vertical-line.png}" style="width:30px;" alt="">가게 등록
        </h3>
        <p class="p-line">가게 상세</p> <hr>
        <form th:action="@{/manage/dyning/register}" th:method="post" id="form">
          <div class="col-12 py-3">
            <label for="" class="form-label">아이디</label>
            <input type="text" name="id" th:value="${id}" class="form-control" readonly>
         </div>
         <div class="col-12 py-3">
           <label for="" class="form-label">가게명</label>
           <input type="text" name="dyningname" id="" class="form-control">         
          </div>
         <div class="col-12 py-3">
          <label for="" class="form-label">사장님 한마디</label>
          <input type="text" name="comment" id="" class="form-control">
        </div>
        <div class="col-12 py-3">
          <label for="" class="form-label">가게 위치</label>
          <div class="input-group mb-3">
            <input type="text" name="location" id="" class="form-control" readonly style="background-color: white;">
            <input type="button" value="우편찾기" id="address" class="btn btn-outline-secondary">
          </div>
            <input type="text" name="locationdetails" id="detail" placeholder="상세주소" class="form-control col-12">
        </div>
        <div class="col-12 py-3">
          <label for="" class="form-label">가게 연락처</label>
            <input type="text" name="tel" id=""  class="form-control">
        </div>
        <div class="col-12 py-3">
          <label for="" class="form-label">음식 종류</label>
            <select name="foodtype" id="" class="form-select">
              <option value="1">카페</option>
              <option value="2">한식</option>
              <option value="3">일식</option>
              <option value="4">중식</option>
              <option value="5">양식</option>
            </select>
        </div>
        <div class="col py-3">
          <label for="" class="form-label">영업 시간</label>
          <input name="businesshours" id="hourstext" cols="62" rows="5" style="resize: none;" class="form-control" wrap="hard"></input>
          <!-- <input type="text" name="businesshours" id="" class="form-control"> -->
        </div>
        <div class="col-12 py-3">
          <label for="" class="form-label">해시태그</label>
          <input type="text" name="hashtag" id="" class="form-control">
        </div>
        <p class="p-line pt-2">이미지 업로드</p><hr>
        <div class="col-12 py-3">
          <label for="" class="form-label">메뉴 이미지 (중복 선택 가능)</label>
            <div class="form-group menuimage">
              <div class="custom-file">
                <input type="file" class="custom-file-input1 files form-control" id="fileInput1" multiple >
                <label data-browse="Browse"></label>
              </div>
            </div>
          </div>
            <div class="menubox">
            </div>
            <div class="menuuploadResult">
              <ul></ul>
            </div>
      <div class="col-12">
          <label for="" class="form-label">가게 배경 이미지 (1장 선택 가능)</label>
            <div class="form-group background">
              <div class="custom-file">
                <input type="file" class="custom-file-input2 files form-control" id="fileInput2" >
                <label data-browse="Browse"></label>
              </div>
            </div>
            <div class="backgroundbox">
            </div>
            <div class="backgroundshowResult">
              <ul></ul>
            </div>
          </div>  
          <p class="p-line pt-2">지붕</p><hr>
          <div class="col-12">
            <input type="hidden" name="oono" id="roofdisign" value="">
            <button type="button" id="roofChoice" class="btn">
              지붕 선택하기
            </button> 
            <br><img id="selectedroof" src="" alt="">
        </div>

        </form>

        <button type="button" id="btn-submit" class="btn my">등록하기</button>
      </div>
    </div>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:inline="javascript">

      window.onload = function () {
        document.getElementById("address").addEventListener("click", function () { //주소입력칸을 클릭하면
          //카카오 지도 발생
          new daum.Postcode({
            oncomplete: function (data) { //선택시 입력값 세팅
              document.querySelector("input[name=location]").value = data.address; // 주소 넣기
              document.getElementById("detail").focus(); //상세입력 포커싱
              window.close();
            }
          }).open();
        });
      }

      $(document).ready(function (e) {

        $("#roofChoice").on("click", function (e) {
          $("#roofModal").show();
        });

        $(".okBtn").on("click", function (e) {
          var rooftype = $('input[name="oono"]:checked');
          var selectedroofimage = rooftype.next().children("img").attr("src");
          $("#roofdisign").val(rooftype.val());
          $('#selectedroof').attr("src", selectedroofimage);
          $("#roofModal").hide();
        });

        $("button[name='btn-close']").on("click", function (e) {
          $("#roofModal").hide();
        });

        $("#hourstext").val().replace(/\n/g, "<br>")

        //  upload url 선언 및 초기화
        /*[+
          var urlUpload = [[@{/uploadAjax/}]];
        +]*/

        // 입력 파일 형식 및 크기 제한 : 여기서는 jpg만 받음
        // 이걸 함수에서만 쓰는거면 지역변수로 넣는게 좋은듯
        var regex = new RegExp("(.*?)\.(exe|sh|zip|alz|tiff|txt)$");
        var maxSize = 10485760;

        // 이미지 파일 유효성 검사를 위한 함수 fileName과 fileSize를 파라미터로 받음
        function checkExtension(fileName, fileSize) {
          // 사이즈 유효성 검사
          if (fileSize >= maxSize) {
            alert("파일사이즈 초과");
            return false;
          }
          // 파일 이름으로 유효성 검사
          // regex에 .이 포함되어있으니까 +1을 안해줘도 돼
          if (regex.test(fileName.substring(fileName.lastIndexOf(".")))) {
            // alert("해당파일은 업로드 될 수 없습니다!");
            return false;
          }

          return true;
        }

        // 해당 클래스에 변화가 있을 때 동작하는 이벤트
        $(".custom-file-input1").on("change", function () {

          // this 즉 이벤트 타겟의 값을 불러와서 기준값에 따라서 배열로 나누고 배열에서 마지막 요소를 제거하고 그 요소를 반환(pop메소드)
          var fileName = $(this).val().split("/").pop();

          // 테스트용 콘솔
          // console.log("fileName >> " + fileName);
          // console.log("확장자 인덱스 >> " + fileName.lastIndexOf("."));
          // console.log("확장자 >> " + fileName.substring(fileName.lastIndexOf(".") + 1));

          // 해당 클래스에 selected라는 클래스를 추가함
          $(this).siblings(".custom-file-label").addClass("selected").html(fileName);

          var formData = new FormData(); //Form태그에 동적으로 데이터할당
          var inputFile = $(this); // 이벤트 대상
          var files = inputFile[0].files; // 해당 파일 객체
          var appended = false; // 추가가 정상적으로 이루어졌는지 확인하기 위한 boolean 변수

          for (let i = 0; i < files.length; i++) {
            if (!checkExtension(files[i].name, files[i].size)) {
              // 여기서 유효성 검사 통과하지 못하면 파일선택에 들어가있는 값 털어버리는 것 추가 필요 서치 더 해보기
              return false;
            }
            console.log(files[i]);
            formData.append("uploadFiles", files[i]); // if문을 통과하는경우에 Form태그에 데이터를 append시킴
            appended = true; // 제대로 추가돼었다는것을 알리기위해서 true값 재할당
          }


          if (!appended) { return; } // 어펜드가 제대로 되지 않은 경우에 리턴하는데 위에서 return false로 함수 나가게 했으니까 필요없지 않나?

          // value라는 변수에 formData의 값들을 하나씩 넣음 forEach내지 향포 개념임 for of 반복문
          for (var value of formData.values()) console.log("formData >> " + value);

          // 파일 업로드를 위한 ajax
          $.ajax({
            url: urlUpload, // 스크림트 도입부에 url 올려둠
            processData: false,
            contentType: false,
            data: formData,
            type: 'POST',
            dataType: 'json',
            success: function (result) {
              console.log(result);
              menushowResult(result);
            },
            error: function (jqXHR, textStatus, errorThrown) { // 이 부분 잘 이해 안됐음
              console.log(textStatus);
            }
          });
        });

        $(".custom-file-input2").on("change", function () {

          // this 즉 이벤트 타겟의 값을 불러와서 기준값에 따라서 배열로 나누고 배열에서 마지막 요소를 제거하고 그 요소를 반환(pop메소드)
          var fileName = $(this).val().split("/").pop();

          // 테스트용 콘솔
          // console.log("fileName >> " + fileName);
          // console.log("확장자 인덱스 >> " + fileName.lastIndexOf("."));
          // console.log("확장자 >> " + fileName.substring(fileName.lastIndexOf(".") + 1));

          // 해당 클래스에 selected라는 클래스를 추가함
          $(this).siblings(".custom-file-label").addClass("selected").html(fileName);

          var formData = new FormData(); //Form태그에 동적으로 데이터할당
          var inputFile = $(this); // 이벤트 대상
          var files = inputFile[0].files; // 해당 파일 객체
          var appended = false; // 추가가 정상적으로 이루어졌는지 확인하기 위한 boolean 변수
          
          // if (files.length > 1 || $(".backgroundshowResult ul li").length != 0) {  
          //   $("#fileInput2").val(""); 
          //   swal({title:"알림", text:"배경 사진은 1장만 추가 가능합니다", button:false, timer:1500,}) return;  
          // }
         
          for (let i = 0; i < files.length; i++) {
            if (!checkExtension(files[i].name, files[i].size)) {
              // 여기서 유효성 검사 통과하지 못하면 파일선택에 들어가있는 값 털어버리는 것 추가 필요 서치 더 해보기
              return false;
            }
            console.log(files[i]);
            formData.append("uploadFiles", files[i]); // if문을 통과하는경우에 Form태그에 데이터를 append시킴
            appended = true; // 제대로 추가돼었다는것을 알리기위해서 true값 재할당
          }

          if (!appended) { return; } // 어펜드가 제대로 되지 않은 경우에 리턴하는데 위에서 return false로 함수 나가게 했으니까 필요없지 않나?

          // value라는 변수에 formData의 값들을 하나씩 넣음 forEach내지 향포 개념임 for of 반복문
          for (var value of formData.values()) console.log("formData >> " + value);

          // 파일 업로드를 위한 ajax
          $.ajax({
            url: urlUpload, // 스크림트 도입부에 url 올려둠
            processData: false,
            contentType: false,
            data: formData,
            type: 'POST',
            dataType: 'json',
            success: function (result) {
              console.log(result);
              backgroundshowResult(result);
            },
            error: function (jqXHR, textStatus, errorThrown) { // 이 부분 잘 이해 안됐음
              console.log(textStatus);
            }
          });
        });

        // showResult 함수 선언
        function menushowResult(uploadResultArr) {
          var uploadUL = $(".menuuploadResult ul");
          var str = "";

          /*[+
          var urlDisplay=[[@{/display}]];
          +]*/

          $(uploadResultArr).each(function (i, obj) {
            str += `<li data-name='${obj.fileName}' data-file='${obj.imageURL}\' data-path='${obj.folderPath}' data-uuid='${obj.uuid}'><div>
             <button type='button' data-file='${obj.imageURL}'><i class="fa-solid fa-x"></i></button><br>
             <img src='${urlDisplay}?fileName=${obj.thumbnailURL}'></div></li>`;
          });
          uploadUL.append(str);
        }

        function backgroundshowResult(uploadResultArr) {
          var uploadUL = $(".backgroundshowResult ul");
          var str = "";
          /*[+
          var urlDisplay=[[@{/display}]];
          +]*/
          $(uploadResultArr).each(function (index, obj) {
            str += `<li data-name='${obj.fileName}' data-file='${obj.imageURL}\' data-path='${obj.folderPath}' data-uuid='${obj.uuid}'><div>
            <button type='button' data-file='${obj.imageURL}'><i class="fa-solid fa-x"></i></button><br>
            <img src='${urlDisplay}?fileName=${obj.thumbnailURL}'></div></li>`;
          });
          uploadUL.append(str); // ul에 전달쓰
        }

        // submit 버튼
        $("#btn-submit").on("click", function (e) {
          e.preventDefault(); // 기본 이벤트 submit을 막음
          if ($("input[name=dyningname]").val() == "") {
            swalModalInfo("가게명을 입력해주세요");
            $("input[name=dyningname]").focus();
            return;
          } else if ($("input[name=comment]").val() == "") {
            swalModalInfo("사장님 한마디를 입력해주세요");
            $("input[name=comment]").focus();
            return;
          } else if ($("input[name=location]").val() == "") {
            swalModalInfo("가게 위치를 입력해주세요");
            $("input[name=location]").focus();
            return;
          } else if ($("input[name=locationdetails]").val() == "") {
            swalModalInfo("가게 위치 상세를 입력해주세요");
            $("input[name=locationdetails]").focus();
            return;
          } else if ($("input[name=tel]").val() == "") {
            swalModalInfo("가게 연락처를 입력해주세요");
            $("input[name=tel]").focus();
            return;
          } else if ($("input[name=foodtype]").val() == "") {
            swalModalInfo("음식 종류를 입력해주세요");
            $("input[name=foodtype]").focus();
            return;
          } else if ($("input[name=businesshours]").val() == "") {
            swalModalInfo("영업 시간을 입력해주세요");
            $("input[name=businesshours]").focus();
            return;
          } else if ($("input[name=hashtag]").val() == "") {
            swalModalInfo("해시태그를 입력해주세요");
            $("input[name=hashtag]").focus();
            return;
          } else if ($(".menuuploadResult ul").children('li').length == 0) {
            swalModalInfo("메뉴 사진을 입력해주세요");
            $("input[name=foodtype]").focus();
            return;
          } else if ($(".backgroundshowResult ul").children('li').length == 0) {
            swalModalInfo("배경 사진을 입력해주세요");
            return;
            swal("알림", "배경 사진을 선택해주세요 입력해주세요");
            return;
          } else if ($("input[name=oono]").val() == "") {
            swalModalInfo("지붕 디자인을 입력해주세요");
            $("input[name=oono]").focus();
            return;
          }

          function swalModalInfo(Text){
            swal({
              title: "알림",
              text: Text,
              icon: "info",
              button:false,
              timer: 1500});
             
          }

          // 빈 문자열
          var str = "";
          var str2 = "";
          $(".menuuploadResult li").each(function (i, obj) {
            // each로 i idx값과 obj value값을 받아옴
            var target = $(obj);
            str += `<input type='hidden' name='dyningImageDTOList[${i}].menuimagename' value='${target.data('name')}'>`;
            str += `<input type='hidden' name='dyningImageDTOList[${i}].menuimageuuid' value='${target.data('uuid')}'>`;
            str += `<input type='hidden' name='dyningImageDTOList[${i}].menuimagepath' value='${target.data('path')}'>`;
          });


          $(".backgroundshowResult li").each(function (i, obj) {
            // each로 i idx값과 obj value값을 받아옴
            var target = $(obj);
            str2 += `<input type='hidden' name='dyningImageDTOList[${i}].backgroundname' value='${target.data('name')}'>`;
            str2 += `<input type='hidden' name='dyningImageDTOList[${i}].backgrounduuid' value='${target.data('uuid')}'>`;
            str2 += `<input type='hidden' name='dyningImageDTOList[${i}].backgroundpath' value='${target.data('path')}'>`;
          });

          $(".menubox").html(str);
          $(".backgroundbox").html(str2);

          $("form").submit();
        });

        // 사진 삭제
        $(".menuuploadResult ").on("click", "li button", function (e) {
          
          console.log("delete file...");
          
          var targetFile = $(this).data("file");
          var targetLi = $(this).closest("li");

          /*[+
            var urlRemove = [[@{/removeFile}]];
          +]*/

          $.ajax({
            url: urlRemove,
            data: { fileName: targetFile },
            dataType: 'text',
            type: 'POST',
            success: function (result) {
              targetLi.remove();
            }
          });
          deleteFileValue(targetLi.index());
        });

        const deleteFileValue = (fileNum) => {
          const dataTransfer = new DataTransfer();
          let files = $("#fileInput1")[0].files;
          let fileArray = Array.from(files);
          fileArray.splice(fileNum, 1);
          fileArray.forEach(file => {
            dataTransfer.items.add(file);
          });
          $("#fileInput1")[0].files = dataTransfer.files;
        }

        $(".backgroundshowResult").on("click", "li button", function (e) {
          console.log("delete file...");

          var targetFile = $(this).data("file");
          var targetLi = $(this).closest("li");

          /*[+
            var urlRemove = [[@{/removeFile}]];
          +]*/

          $.ajax({
            url: urlRemove,
            data: { fileName: targetFile },
            dataType: 'text',
            type: 'POST',
            success: function (result) {
              targetLi.remove();
            }

          });

          $("#fileInput2").val("");

        });
      });

    </script>

    <div id="roofModal" class="modal roofModal" tabindex="-2">
      <div class="modal-dialog modal-lg roofmodal">
        <div class="modal-content modal-lg">
          <div class="modal-header modal-lg">
            <h5 class="modal-title">지붕 디자인 선택</h5>
            <button type="button" class="btn-close close" data-bs-dismiss="modal" aria-label="Close"
              name='btn-close'></button>
          </div>
          <div class="modal-body modal-lg">
            <span th:each="roof : ${roofList}">
              <input type="radio" class="radio" name="oono" th:id="${roof.rooftype}" th:value="${roof.rooftype}" hidden>
              <label th:for="${roof.rooftype}">
                <img th:src="${roof.roofthumbnail}" alt="">
              </label>
            </span>
          </div>

          <div class="modal-footer modal-lg">
            <button type="button" class="basic-button okBtn" data-bs-dismiss="modal">선택하기</button>
            <button type="button" class="btn btn-secondary pictureClose close" name='btn-close'
              data-bs-dismiss="modal">닫기</button>
          </div>
        </div>
      </div>
    </div>

  </th:block>
</th:block>
