<!DOCTYPE html>
<html lang="ko" xmls:th="http://www.thymeleaf.org">

<th:block th:replace="~{layout/basic :: setContent(~{::content})}">
    <th:block th:fragment="content">
        <h1>전시회 등록페이지</h1>

        <form th:action="@{/manage/gallery/register}" th:method="POST" id="frm">
            <label for="userid"> user id 추후 hidden으로 변경 </label><br>
            <input type="text" name="id" value="user1@icloud.com"><br>

            <label>출품 유형</label> <br>
            <select name="imagetype" id="imagetype">
                <option value="" aria-disabled="false" selected>선택하세요</option>
                <option value="1">그림전</option>
                <option value="0">사진전</option>
            </select><br>

            <label for="title">title</label><br>
            <input type="text" name="title" placeholder="title"><br>

            <label for="content">explain</label><br>
            <input type="text" name="content" placeholder="explain"><br>
            <div class="box">
            </div>
        </form>
            <!-- 여기서 input 으로 전달해주는 값을 img 아래로 내리니까 전달자체가 되지 않았음 -->
            <label>Image & Frame</label>
            <div class="custom-file">
                <input type="file" class="custom-file-input files form-control" id="fileInput" multiple>
                <label data-browse="Browse"></label>
            </div>
            </div>

        <!-- upload된 이미지 파일을 보여주기 위한 list style 설정 -->
        <style>
            .uploadResult {
                width: 100%;
                background: gray;
                margin-top: 10px;
            }

            .uploadResult ul {
                display: flex;
                flex-flow: row;
                justify-content: center;
                align-items: center;
                vertical-align: top;
                overflow: auto;
            }

            .uploadResult ul li {
                list-style: none;
                padding: 10px;
                margin-left: 2em;
            }

            .uploadResult ul li img {
                width: 100px;
            }
        </style>

        <!-- 업로드된 사진이 보여질 div안의 ul태그 -->
        <div class="uploadResult">
            <ul>

            </ul>
        </div>


        <button id="register">등록</button>
        </form>
        <a th:href="@{/main/mypage(id='user1@icloud.com')}"><input type="button" value="돌아가기(마이페이지)"></a>
        <a th:href="@{/manage/gallery/list(id='user1@icloud.com')}"><input type="button" value="돌아가기(리스트)"></a>

        <script th:inline="javascript">

            $(document).ready(function (e) {

                var regex = new RegExp("(.*?)\.(exe|sh|zip|alz|tiff|txt)$");
                var maxSize = 10485760;

                function checkExtension(fileName, fileSize) {
                    // 사이즈 유효성 검사
                    if (fileSize >= maxSize) {
                        alert("파일사이즈 초과");
                        return false;
                    }
                    // 파일 이름으로 유효성 검사 
                    if (regex.test(fileName.substring(fileName.lastIndexOf(".")))) {
                        return false;
                    }
                    return true;
                }

                // 해당 클래스에 변화가 있을 때 동작하는 이벤트
                $(".custom-file-input").on("change", function () {
                    var fileName = $(this).val().split("/").pop();

                    // 테스트용 콘솔
                    console.log("fileName >> " + fileName);
                    console.log("확장자 인덱스 >> " + fileName.lastIndexOf("."));
                    console.log("확장자 >> " + fileName.substring(fileName.lastIndexOf(".") + 1));

                    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);

                    var formData = new FormData();
                    var inputFile = $(this);
                    var files = inputFile[0].files;
                    var appended = false;

                    for (let i = 0; i < files.length; i++) {
                        if (!checkExtension(files[i].name, files[i].size)) {
                            return false;
                        }
                        console.log(files[i]);
                        formData.append("uploadFiles", files[i]);
                        appended = true;
                    }

                    if (!appended) { return; }

                    for (var value of formData.values()) console.log("formData >> " + value);

                    /*[+
                        var urlUpload = [[@{/uploadAjax/}]];
                     +]*/

                    // 파일 업로드를 위한 ajax
                    $.ajax({
                        url: urlUpload,
                        processData: false,
                        contentType: false,
                        data: formData,
                        type: 'POST',
                        dataType: 'json',
                        success: function (result) {
                            // alert(formData);
                            showResult(result);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus);
                        }
                    });
                });

                // showResult 함수 선언
                function showResult(uploadResultArr) {
                    var uploadUL = $(".uploadResult ul");
                    var str = "";
                    var str2 = "";
                    /*[+
                    var urlDisplay=[[@{/display}]];
                    +]*/
                    $(uploadResultArr).each(function (i, obj) {
                        str += `<li data-name='${obj.fileName}' data-path='${obj.folderPath}' data-uuid='${obj.uuid}'><div>`;
                        str += `<button type='button' data-file='${obj.imageURL}' class='btn-warning btn-sm'>X</button><br>`;
                        str += `<img src='${urlDisplay}?fileName=${obj.thumbnailURL}'></div></li>`;
                    });
                    uploadUL.append(str);

                    $(".uploadResult li").each(function (i, obj) {
                        var target = $(obj);
                        str2 += `<input type='hidden' name='imagename' value='${target.data('name')}'>
                                    <input type='hidden' name='imagepath' value='${target.data('path')}'>
                                    <input type='hidden' name='uuid' value='${target.data('uuid')}'>`;
                    });

                    $(".box").html(str2);
                }

            });

            // submit 버튼
            $("#register").on("click", function (e) {
                e.preventDefault();
                $("form").submit();
                // console.log($("form").serialize());
            });

            // 사진 삭제
            $(".uploadResult ").on("click", "li button", function (e) {
                console.log("delete file...");

                var targetFile = $(this).data("file");
                var targetLi = $(this).closest("li");

                /*[+
                  var urlRemove = [[@{/removeFile}]];
                +]*/

                $.ajax({
                    url: urlRemove,
                    data: { fileName: targetFile },
                    dataType: 'text',
                    type: 'POST',
                    success: function (result) {
                        alert(result ? "Deleted!" : "Error");
                        targetLi.remove();
                    }
                });
            });
        </script>
    </th:block>
</th:block>