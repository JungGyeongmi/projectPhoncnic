<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/basic :: setContent(~{::content})}">
    <th:block th:fragment="content">
        <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
        <table class="table">
            <tr>
                <th>ê´€ë¦¬ìëª…</th>
                <th>ìœ ì €ê²€ìƒ‰</th>
            </tr>
            <tr>
                <td> [[${userId}]] </td>
                <td>
                    <form id="userSearchFrm" action="" method="">
                        <input type="text" value="" name="id" placeholder="ëƒëƒëƒ@gmail.com">
                        <input type="button" value="ê²Ÿ-ì± " id="searchBtn">
                    </form>
                </td>
            </tr>
        </table>
        <div id="searchResult">
        </div>
        <div id="raidoContainer" style="display:none">
            <input id="ROLE_ADMIN" type="radio" name="roleSet" value="[ROLE_ADMIN]">
            <input id="ROLE_USER" type="radio" name="roleSet" value="[ROLE_USER]">
            <input id="ROLE_CEO" type="radio" name="roleSet" value="[ROLE_CEO]">
            <input id="ROLE_ARTIST" type="radio" name="roleSet" value="[ROLE_ARTIST]">
        </div>

        <script th:inline="javascript">
            $(function () {

                /*[+
                    var searchUrl = [[ @{/admin/search} ]]
                    var modifyUrl = [[ @{/admin/modify} ]]
                +]*/

                var userSearchFrm = $("#userSearchFrm");
                var searchResult = $("#searchResult");

                var searchFunction = function () {

                    var id = $("input[name=id]").val();
                    if(id==""|| id==null){
                        searchResult.text("ê²€ìƒ‰ì–´ ì…ë ¥í•˜ìŠˆ");
                        return true;
                    }
                    if(id=="777") {
                        searchResult.text("ğŸ‰ì´ê²ƒì´ ê¶Œë ¥ì˜ ë§›ì´ë‹¤ğŸ‰");
                        return true;
                    }

                    $.ajax({
                        type: "POST",
                        url: searchUrl + "/" + id,
                        contentType: "application/json",
                        success: function (response) {
                            var str = ""
                            if(response.id==null) {
                                str = `<div>ê²€ìƒ‰ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                                searchResult.html(str);
                                return true;
                            } 
                            str = `<form id="memberfrm" action="">
                                            <table class="table" border="1">
                                                <tr>
                                                    <th scope="col">ì•„ì´ë””</th>
                                                    <th scope="col">ë‹‰ë„¤ì„</th>
                                                    <th scope="col">ê¶Œí•œ</th>
                                                    <th scope="col">ê°€ì…ì¼</th>
                                                    <th scope="col">ìˆ˜ì •</th>
                                                </tr>
                                                <tr>
                                                    <input type="hidden" value="${response.id}" name="id" readonly/>
                                                    <td> <span >${response.id}</sapn></td>
                                                    <td><input type="text" value="${response.nickname}" name="nickname"></td>
                                                    <td id="roleSetInfo" data-role-set="${response.roleSet}">
                                                        <label for="ROLE_ADMIN">ROLE_ADMIN</label>&nbsp;
                                                        <label for="ROLE_USER">ROLE_USER</label>&nbsp;
                                                        <label for="ROLE_CEO">ROLE_CEO</label>&nbsp;
                                                        <label for="ROLE_ARTIST">ROLE_ARTIST</label>
                                                    </td>
                                                    <td>${response.regdate}</td>
                                                    <td><button id="memberModifyBtn" type="button">ìˆ˜ì •</button></td>
                                                </tr>
                                            </table>
                                            <input type="hidden" id="modirole" name="roleSet" vlaue="${response.roleSet}" />
                                        </form>`

                            searchResult.html(str);

                            var roleSetData = response.roleSet;

                            roleSetSelector();

                            console.log("get user info success");
                        },
                        fail: function (response) {
                            console.log(response);

                        }, error: function (request, status, error) {
                            console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);

                        }
                    });
                }
            
                var roleSetSelector = function () {
                    $("input[name=roleSet]").each(function (index, item) {
                        var role = $(item).attr("id");
                        var roleSetData = $("#roleSetInfo").data("roleSet");
                        
                        if (role == roleSetData) {
                            $(item).prop("checked", true);
                                $(`#roleSetInfo :nth-child(${index})`).css("color", "red");
                                $("#modirole").val(roleSetData);
                                return true;
                        }
                    });
                }
                
                $("#searchBtn").on("click", searchFunction);
                
                $("#raidoContainer input").on("change", function () {
                    console.log($(this).attr("id"));
                    var id = $(this).attr("id");
                    $("#roleSetInfo").children().each(function (idx) {
                        $(`#roleSetInfo :nth-child(${idx + 1})`).css("color", "black");
                    });
                    selectedRole = $(`label[for=${id}]`).css("color", "red");
                    $("#modirole").val(id);
                })

                $("input[name=id]").on("keydown", function (e) {
                    var keycode = e.keyCode;
                    if (keycode == "13") {
                        e.preventDefault();
                        searchFunction();
                    }
                });

                $(document).on("click", "#memberModifyBtn", function () {
                // var frm = $("#memberfrm").serialize();
                var id = $("input[name=id]").val();
                var nickname = $("input[name=nickname]").val();
                var roleSet = $("#modirole").val();
                var data = { id: id, nickname: nickname };
                // console.log(frm);
                roleSet = roleSet != null ? roleSet : "0";
                $.ajax({
                    type: "POST",
                    data: JSON.stringify(data),
                    url: modifyUrl + "/" + roleSet,
                    contentType: "application/json",
                    success: function (response) {
                        swal("ìˆ˜ì •ì™„");
                        console.log("get modi post success....");
                    },
                    fail: function (response) {
                        console.log(response);
                    }, error: function (reponse, error) {
                        // console.log("code:" + reponse.status + "\n" + "message:" + reponse.responseText + "\n" + "error:" + error);
                        console.log(response.responseText.trace);
                    }
                });
            });

            });

        </script>
    </th:block>
</th:block>