<!DOCTYPE html>
<html lang="ko" xmls:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/dyninglist :: setContent(~{::content}, ~{::search})}">

    <!-- search toggle -->
    <th:block th:fragment="search">
        <style>
            #wrapper {
                background-image: url([[@{/icon/dyning-street.png}]]);
                background-repeat: no-repeat;
                background-size: cover;
                background-position: center;
            }

            .md-serach-result {
                padding: 0 !important;
            }

            .search-result-Item {
                cursor: pointer;
                list-style: none;
                padding-left: 20px;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            .search-result-Item:hover {
                background-color: #DBE9B7;
            }

            #search-result-div {
                padding: 0 !important;
            }

            hr {
                margin: 0;
            }
        </style>

        <div class="border-end bg-white" id="sidebar-wrapper">
            <div class="sidebar-heading border-bottom bg-light">
                <form class="d-flex search-form" th:action="@{/restaurant/toggle}" method="get">
                    <select class="form-select-sm" name="type">
                        <option value="n">가게명</option>
                        <option value="h">해쉬태그</option>
                    </select>
                    <input class="form-control me-2" name="keyword" type="search" placeholder="Search"
                        aria-label="Search">
                    <button class="btn btn-outline-success" id="btnsearch" type="button">Search</button>
                </form>
            </div>
            <div class="list-group list-group-flush">
                <ul class="md-serach-result"></ul>
            </div>
        </div>

        <script th:inline="javascript">
            $(document).ready(function () {
                /*[+
                    var searchUrl = [[@{/dyning/restaurant/toggle}]];
                +]*/

                var btnsearch = $('#btnsearch');
                var searchForm = $('.search-form');
                var searchResult = $(".md-serach-result");
                var keyword = $("input[name=keyword]");

                // 검색버튼 클릭시 search
                btnsearch.on("click", function (e) {
                    console.log(searchForm.serialize());
                    getSearchList();
                });

                // 엔터 입력시 search
                keyword.on("keydown", function (e) {
                    var keycode = e.keyCode;
                    if (keycode == "13") {
                        e.preventDefault();
                        getSearchList();
                    }
                });

                function getSearchList() {
                    $.ajax({
                        type: "GET",
                        url: searchUrl,
                        data: searchForm.serialize(),
                        success: function (response) {
                            console.log("get search success");
                            var str = "";

                            if (response.totalPage != 0) {
                                $.each(response.dtoList, function (idx, dto) {
                                    str += `<li class="search-result-Item " data-search-dno="${dto.dno} " value="${dto.dno}">
                                    <input class="input" type="hidden" value="${dto.dno}">
                                    <div id="search-result-div">
                                            <p>${dto.dyningname}</p>
                                            ${dto.hashtag}
                                        </div>
                                    </li><hr>`;
                                })
                                searchResult.html(str);
                            } else {
                                searchResult.html('<div> 검색 결과가 없습니다. </div>');
                            }
                        },
                        error: function (response) {
                            console.log(response);
                        }
                    });
                }

                // 토글 창 내 search result 클릭 시 이동 제어
                $(document).on("click", ".search-result-Item", function (e) {
                    var chartop = char.offsetTop;
                    var charleft = char.offsetLeft;

                    console.log("click");
                    var val = $(this).attr("value");
                    location.href = "/phoncnic/dyning/details?dno=" + val + "&chartop=" + chartop + "&charleft=" + charleft;
                });
            })
        </script>
    </th:block>

    <!-- 내용부분(cafe 거리) -->
    <th:block th:fragment="content">
        <style>
            body {
                -ms-overflow-style: none;
            }

            ::-webkit-scrollbar {
                display: none;
            }

            .wrap {
                -ms-overflow-style: auto;
                overflow-x: auto;
                /* 단이 나뉘지않고 스크롤이 생김  */
                white-space: nowrap;
                margin: 0 auto;
                scroll-behavior: smooth;
                height: 100%;
                padding-top: 20px;
                padding-bottom: 100px;
            }

            .dyning-list-ul {
                max-width: 10000px;
            }

            #list1 {
                margin: 50px 100px 0px;
                width: 150px;
                height: 150px;
                display: inline-block;
            }

            #list2 {
                margin: 50px 100px 30px;
                padding-top: 50px;
                width: 150px;
                height: 150px;
                display: inline-block;
            }

            .dyningname {
                margin-top: 5px;
                background-color: lightgoldenrodyellow;
                text-align: center;
                font-size: 18px;
                font-family: GmarketSansMedium;
            }

            .nickname {
                border: 2px solid #DBE9B7;
                border-radius: 5px;
                background-color: white;
                text-align: center;
                font-weight: 600;
                font-family: GmarketSansLight;
                overflow: hidden;
            }

            .dyningimg {
                width: 150px;
                height: 150px;
            }

            .ullist {
                padding-left: 150px;
                padding-right: 150px;
            }
        </style>

        <input type="hidden" th:value="${result.page}" id="listpage">
        <input type="hidden" th:value="${result.totalPage}" id="totalpage">
        <div class="wrap" id="wrap">
            <ul class="ullist">
                <th:block th:each="dto, index : ${result.dtoList}" th:if="${index.count}%2 !=0">
                    <li id="list1">
                        <div th:class="@{/dyning/details(dno=${dto.dno},id=${id}) }">
                            <img class="dyningimg" th:src="${dto.getRoofthumbnail}" th:id="${index.count}">
                        </div>
                        <!-- [[${dto.getRoofthumbnail}]] -->
                        <div class="dyningname">
                            [[${dto.getDyningname}]]
                        </div>
                    </li>
                </th:block>
            </ul>
            <div th:each="sdto : ${setDTO}" id="char">
                <img type="hidden" id="charimg" class="look setlook" th:src="${sdto.setpath}" alt="">
                <div th:text="${nickname}" class="nickname" th:if="${nickname}!=''">[[${nickname}]]</div>
                <input type="text" name="chartop" th:value="${chartop}" style="opacity: 0;">
                <input type="text" name="charleft" th:value="${charleft}" style="opacity: 0;">
            </div>
            <ul class="ullist">
                <th:block th:each="dto, index : ${result.dtoList}" th:if="${index.count}%2 == 0">
                    <li id="list2">
                        <div th:class="@{/dyning/details(dno=${dto.dno},id=${id}) }">
                            <img class="dyningimg" th:src="${dto.getRoofthumbnail}" th:id="${index.count}">
                        </div>
                        <div class="dyningname">
                            [[${dto.getDyningname}]]
                        </div>
                    </li>
                </th:block>
            </ul>
        </div>

        <style>
            .setlook {
                position: relative;
                width: 70px;
                height: 98px;
                right: 0px;
            }

            #char {
                position: relative;
                width: 70px;
                height: 126px;
                right: 0px;
            }
        </style>

        <script>
            $(document).ready(function (e) {
                if ($("input[name='chartop']").val() != "") {

                    var top = $("input[name='chartop']").val();
                    var left = $("input[name='charleft']").val();

                    $("#char").offset({ top: top });
                    $("#char").offset({ left: left });

                }
            });

            $(".dyningimg").on("click", function (e) {
                var src = $(this).parent().attr("class");
                var src = $(this).parent().attr("id");
                var top = e.target.offsetTop;
                var left = e.target.offsetLeft;
                console.log(src);
                console.log(top, left);
                // location.href=src;
            });

            (function () {

                document.addEventListener("keydown", function (e) {
                    let char = document.getElementById("char");
                    let charimg = document.getElementById("char");
                    var wrapheight = document.getElementById("wrap").clientHeight;
                    var top = Math.round(wrapheight / 2);

                    var chartop = char.offsetTop;
                    var charleft = char.offsetLeft;
                    $("input[name='chartop']").val(chartop);
                    $("input[name='charleft']").val(charleft);

                    let key = e.keyCode;
                    let y = parseInt(char.style.top || 0, 10);
                    let x = parseInt(char.style.left || 0, 10);
                    if (key === 37 /* LEFT */) {
                        char.style.left = x - 20 + "px";
                    }
                    if (key === 38 /* TOP */) {
                        char.style.top = y - 20 + "px";
                    }
                    if (key === 39 /* RIGHT */) {
                        char.style.left = x + 20 + "px";
                    }
                    if (key === 40 /* BOTTOM */) {
                        char.style.top = y + 20 + "px";
                    }

                    // →방향키
                    if (key === 39) {
                        var imgLength = $(".dyningimg").length;
                        var screenWidth = window.screen.width;
                        var screenHeight = window.screen.availHeight;
                        var listpage = Number(document.querySelector("#listpage").value) + 1;

                        if (listpage - 1 == totalpage) {
                            return;
                        }
                        if (charleft > screenWidth - 200) {
                            $("body div").animate({
                                "opacity": "0",
                                "top": "100px"
                            }, 100, function () {
                                location.replace(listlocation + listpage + "&top=" + top + "&left=" + 40);
                            });
                        };
                    }

                    // ←방향키
                    if (key === 37) {
                        var imgLength = $(".dyningimg").length;
                        var screenWidth = window.screen.width;
                        var screenHeight = window.screen.availHeight;
                        var left = screenWidth - 100;
                        var listpage = Number(document.querySelector("#listpage").value) - 1;

                        if (listpage >= 1) {
                            if (charleft < 100) {
                                $("body div").animate({
                                    "opacity": "0",
                                    "top": "100px"
                                }, 100, function () {
                                    location.replace(listlocation + listpage + "&top=" + top + "&left=" + left);
                                });
                            } else {
                                return;
                            }
                        }
                    }
                });

                document.addEventListener("keyup", function (e) {
                    var chartop = char.offsetTop;
                    var charleft = char.offsetLeft;
                    let key = e.keyCode;
                    $("input[name='chartop']").val(chartop);
                    $("input[name='charleft']").val(charleft);

                    if (key === 13 /* BOTTOM */) {
                        var imgLength = $(".dyningimg").length;
                        console.log("캐릭터좌표" + chartop, charleft);

                        for (i = 1; i <= imgLength; i++) {
                            // 절대 좌표
                            var targetTop = document.getElementById(i).offsetTop;
                            var targetLeft = document.getElementById(i).offsetLeft;
                            var targetHref = $("#" + i).parent().attr('class');
                            console.log("타겟좌표: " + targetTop, targetLeft, targetHref);

                            if (targetTop - 20 < chartop && chartop < targetTop + 100 && targetLeft - 30 < charleft && charleft < targetLeft + 100) {
                                location.href = targetHref + "&chartop=" + chartop + "&charleft=" + charleft;
                            };
                        }
                    }
                });
            })();
        </script>

        <script th:inline="javascript">
            // 방향키(37~40), space바(32)로 스크롤 이동 막기
            window.addEventListener("keydown", function (e) {
                if ([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
                    e.preventDefault();
                }
            }, false);
        </script>

    </th:block>
</th:block>