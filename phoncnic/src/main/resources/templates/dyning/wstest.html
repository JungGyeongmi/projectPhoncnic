<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1> WSTEST</h1>
    <style>
         .setlook {
                position: relative;
                width: 70px;
                height: 98px;
                right: 0px;
            }
            #char{
                position: relative;
                width: 70px;
                height: 98px;
                right: 0px;
            }
    </style>
    <body>
        <!-- <input type="text" id="top">
        <input type="text" id="left">
        <input type="text" id="testInput"> -->
        <div id="testdiv"></div>
        <input type="hidden" id="nickname" class="form-inline" placeholder="닉네임을 입력해주세요" th:value="${nickname}" required autofocus>
        <!-- <button class = "btn btn-primary" id = "name">확인</button> -->
        <!-- <div id = "chatroom" style = "width:1000px; height: 1000px; border:1px solid; background-color : white; overflow: auto;" ></div> -->
        <input type = "text" id = "message" style = "height : 30px; width : 340px" placeholder="내용을 입력하세요" autofocus>
        <button class = "btn btn-primary" id = "send">전송</button>
        <div th:each="sdto : ${setDTO}" id="char" >
            <input type = "hidden" id ="charimg" th:value="${sdto.setpath}">
            <!-- <div id="nickname" th:value="${nickname}" class="nickname" th:if="${nickname}!=''">[[${nickname}]]</div> -->
        </div>
        <script>
     
        </script>
    </body>
    <script  src="http://code.jquery.com/jquery-latest.min.js"></script>

    <script>
        var webSocket;
        var nickname;
        nickname = document.getElementById("nickname").value;
        
        setpath = document.getElementById("charimg").value;
        connect();
        charTop =  document.getElementById("charimg").offsetTop;
        charLeft =  document.getElementById("charimg").offsetLeft;
        str =nickname +','+charTop +','+charLeft;


    
      
        function connect(){
            webSocket = new WebSocket("wss://28c0-175-119-172-242.jp.ngrok.io/phoncnic/street");
            webSocket.onopen = onOpen;
            webSocket.onclose = onClose;
            webSocket.onmessage = onMessage;
        }
        function disconnect(){
            webSocket.send(nickname + "님이 퇴장하셨습니다");
            webSocket.close();
        }
        document.addEventListener("keyup", function(){
            send();
        });

        function send(){
            webSocket.send(str);
        }
        function onOpen(){
            // webSocket.send("<div style='display:inline-block;' data-top="+charTop+" data-left="+charLeft+"><img id="+nickname+" src="+setpath+" width='70px'>"+"<br>"+nickname+"</div>");

            webSocket.send("<div><img id="+nickname+" src="+setpath+" style='width: 70px;'><br>"+nickname+"</div>");

        }
        function onMessage(e){
            data = e.data;
            // testInput = document.getElementById("testInput").value;
            testdiv = document.getElementById("testdiv");
            if (data.substring(0,1)==="<") {
                testdiv.innerHTML = testdiv.innerHTML + "<br>" + data;
            }else if(data!=""){
                
                var dataSplit = data.split(',');
                
                // document.getElementById(dataSplit[0]).offset({top : 300, left: 300});
               $("#"+dataSplit[0]).offset({ top:dataSplit[1] });
               $("#"+dataSplit[0]).offset({ left:dataSplit[2] });

            }
            

            

           
        }
        function onClose(){
 
        }
        
    </script>
    <script>
        (function () {

    document.addEventListener("keydown", function (e) {
    let char = document.getElementById("charimg");


    let key = e.keyCode;
    let y = parseInt(char.style.top || 0, 10);
    let x = parseInt(char.style.left || 0, 10);
    if (key === 37 /* LEFT */) {
        char.style.left = x - 20 + "px";
    }
    if (key === 38 /* TOP */) {
        char.style.top = y - 20 + "px";
    }
    if (key === 39 /* RIGHT */) {
        char.style.left = x + 20 + "px";
    }
    if (key === 40 /* BOTTOM */) {
        char.style.top = y + 20 + "px";
    }
})
}
);
    </script>
</body>

</html>